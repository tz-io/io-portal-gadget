<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Graph API Sample</title>
    <script src="https://alcdn.msauth.net/browser/2.33.0/js/msal-browser.min.js"></script>
    <script>
        // Cookieから値を取得する関数
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // クッキーを設定する関数
        function setCookie(name, value) {
            document.cookie = `${name}=${encodeURIComponent(value)}; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT;`;
        }
        
        // MSALインスタンスとGraph API設定を初期化する関数
        function initializeMSAL() {
            const clientId = getCookie("clientId"); // クライアントIDをCookieから取得
            const tenantId = getCookie("tenantId"); // テナントIDをCookieから取得

            if (!clientId || !tenantId) {
                alert("クライアントIDまたはテナントIDがCookieに存在しません。");
                throw new Error("Missing clientId or tenantId in cookies.");
            }

            // MSAL Configuration
            return new msal.PublicClientApplication({
                auth: {
                    clientId: clientId,
                    authority: `https://login.microsoftonline.com/${tenantId}`,
                    redirectUri: "https://tz-io.github.io/io-portal-gadget/docs/msGraphTest/"
                }
            });
        }

        // MS Graph API呼び出し処理
        async function signInAndFetchData() {
            try {
                const msalInstance = initializeMSAL();

                // サインイン処理
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["User.Read"]
                });
                console.log("id_token acquired:", loginResponse);

                // アクセストークン取得
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ["User.Read"],
                    account: loginResponse.account
                });
                const accessToken = tokenResponse.accessToken;
                console.log("Access Token acquired:", accessToken);

                // MS Graph API呼び出し
                const graphResponse = await fetch("https://graph.microsoft.com/v1.0/me", {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                const userData = await graphResponse.json();
                console.log("Graph API Response:", userData);

                // 結果を表示
                document.getElementById("result").innerText = JSON.stringify(userData, null, 2);
            } catch (error) {
                console.error("Error during sign-in or data fetching:", error);
                alert("エラーが発生しました。詳細はコンソールを確認してください。");
            }
        }
    </script>
</head>
<body>
    <h1>MS Graph API Sample</h1>
    <button onclick="signInAndFetchData()">Sign In and Fetch Data</button>
    <pre id="result" style="background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd;"></pre>
</body>
</html>
