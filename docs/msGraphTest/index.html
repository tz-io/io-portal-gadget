<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Graph API: Fetch Messages by ParentMessageId</title>
    <script src="https://alcdn.msauth.net/browser/2.33.0/js/msal-browser.min.js"></script>
    <script>
        // Cookieから値を取得する関数
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // MSALインスタンスとGraph API設定を初期化する関数
        function initializeMSAL() {
            const clientId = getCookie("clientId");
            const tenantId = getCookie("tenantId");

            if (!clientId || !tenantId) {
                alert("クライアントIDまたはテナントIDがCookieに存在しません。");
                throw new Error("Missing clientId or tenantId in cookies.");
            }

            // MSAL Configuration
            return new msal.PublicClientApplication({
                auth: {
                    clientId: clientId,
                    authority: `https://login.microsoftonline.com/${tenantId}`,
                    redirectUri: "https://tz-io.github.io/io-portal-gadget/docs/msGraphTest/callback.html"
                }
            });
        }

        // MS Graph API: 指定されたメッセージとその返信を取得する関数
        async function fetchMessageAndReplies(accessToken, chatId, messageId) {
            try {
                const graphResponse = await fetch(`https://graph.microsoft.com/v1.0/chats/${chatId}/messages/${messageId}/replies`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });

                if (!graphResponse.ok) {
                    throw new Error(`HTTP error! status: ${graphResponse.status}`);
                }

                const repliesData = await graphResponse.json();
                return repliesData.value; // メッセージの返信を返す
            } catch (error) {
                console.error("Error fetching message replies:", error);
                throw error;
            }
        }

        // 認証とデータ取得のメイン処理
        async function signInAndFetchReplies() {
            try {
                const msalInstance = initializeMSAL();

                // サインイン処理
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["User.Read", "Chat.Read"] // 必要スコープ
                });
                console.log("id_token acquired:", loginResponse);

                // アクセストークン取得
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ["User.Read", "Chat.Read"],
                    account: loginResponse.account
                });
                const accessToken = tokenResponse.accessToken;
                console.log("Access Token acquired:", accessToken);

                // チャットIDと親メッセージIDを指定
                const chatId = "19%3Aae947f62d8304c2ebf4d949f6b401388%40thread.tacv2";
                const parentMessageId = "1732262751351";

                // メッセージとその返信を取得
                const replies = await fetchMessageAndReplies(accessToken, chatId, parentMessageId);

                // メッセージを画面に表示
                const resultElement = document.getElementById("result");
                resultElement.innerHTML = `<h2>Replies for Message ID: ${parentMessageId}</h2>`;
                replies.forEach(reply => {
                    const replyElement = document.createElement("p");
                    replyElement.textContent = `[${reply.from?.user?.displayName || "Unknown"}]: ${reply.body.content}`;
                    resultElement.appendChild(replyElement);
                });
            } catch (error) {
                console.error("Error during sign-in or fetching replies:", error);
                alert("エラーが発生しました。詳細はコンソールを確認してください。");
            }
        }
    </script>
</head>
<body>
    <h1>MS Graph API: Fetch Replies for Parent Message</h1>
    <button onclick="signInAndFetchReplies()">Sign In and Fetch Replies</button>
    <div id="result" style="background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd;"></div>
</body>
</html>
